<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - MySoulMate</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <!-- Header simplificado -->
    <header class="auth-header">
        <nav class="auth-nav">
            <div class="logo" onclick="window.location.href='index.html'">MySoulMate</div>
            <div class="auth-links">
                <a href="login.html" class="auth-link">¬øYa tienes cuenta? Inicia sesi√≥n</a>
            </div>
        </nav>
    </header>

    <main class="auth-main">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header-content">
                    <h1 class="auth-title">√önete a MySoulMate</h1>
                    <p class="auth-subtitle">üíï Encuentra tu alma gemela universitaria üíï</p>
                </div>

                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-step active">
                        <div class="step-number">1</div>
                        <div class="step-label">Informaci√≥n b√°sica</div>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-number">2</div>
                        <div class="step-label">Cuestionario</div>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-number">3</div>
                        <div class="step-label">¬°Listo!</div>
                    </div>
                </div>

                <form id="registerForm" class="auth-form" novalidate>
                    <!-- Informaci√≥n Personal -->
                    <div class="form-section">
                        <h3 class="section-title">üìù Informaci√≥n Personal</h3>
                        
                        <div class="form-group">
                            <label for="name" class="form-label">Nombre completo *</label>
                            <input 
                                type="text" 
                                id="name" 
                                name="name" 
                                class="form-input" 
                                placeholder="Ingresa tu nombre completo"
                                maxlength="50"
                                required
                            >
                            <div class="input-error" id="nameError"></div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">Email universitario *</label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                class="form-input" 
                                placeholder="tu.nombre@universidad.edu"
                                maxlength="100"
                                required
                            >
                            <div class="input-help">Usa tu email universitario oficial</div>
                            <div class="input-error" id="emailError"></div>
                        </div>

                        <div class="form-group">
                            <label for="age" class="form-label">Edad *</label>
                            <input 
                                type="number" 
                                id="age" 
                                name="age" 
                                class="form-input" 
                                placeholder="Ej: 20"
                                min="18"
                                max="35"
                                required
                            >
                            <div class="input-error" id="ageError"></div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Acad√©mica -->
                    <div class="form-section">
                        <h3 class="section-title">üéì Informaci√≥n Acad√©mica</h3>
                        
                        <div class="form-group">
                            <label for="university" class="form-label">Universidad *</label>
                            <select id="university" name="university" class="form-select" required>
                                <option value="">Selecciona tu universidad</option>
                                <option value="Universidad del Valle de Guatemala">Universidad del Valle de Guatemala (UVG)</option>
                                <option value="Universidad Rafael Land√≠var">Universidad Rafael Land√≠var (URL)</option>
                                <option value="Universidad del Istmo">Universidad del Istmo (UNIS)</option>
                                <option value="Universidad Francisco Marroqu√≠n">Universidad Francisco Marroqu√≠n (UFM)</option>
                                <option value="Universidad de San Carlos">Universidad de San Carlos (USAC)</option>
                                <option value="Otra">Otra universidad</option>
                            </select>
                            <div class="input-error" id="universityError"></div>
                        </div>

                        <div class="form-group">
                            <label for="career" class="form-label">Carrera</label>
                            <input 
                                type="text" 
                                id="career" 
                                name="career" 
                                class="form-input" 
                                placeholder="Ej: Ingenier√≠a en Sistemas"
                                maxlength="100"
                            >
                            <div class="input-error" id="careerError"></div>
                        </div>

                        <div class="form-group">
                            <label for="semester" class="form-label">Semestre/A√±o</label>
                            <select id="semester" name="semester" class="form-select">
                                <option value="">Selecciona tu semestre</option>
                                <option value="1">1er semestre</option>
                                <option value="2">2do semestre</option>
                                <option value="3">3er semestre</option>
                                <option value="4">4to semestre</option>
                                <option value="5">5to semestre</option>
                                <option value="6">6to semestre</option>
                                <option value="7">7mo semestre</option>
                                <option value="8">8vo semestre</option>
                                <option value="9">9no semestre</option>
                                <option value="10">10mo semestre</option>
                                <option value="11">M√°s de 10 semestres</option>
                                <option value="12">Graduado/a</option>
                            </select>
                            <div class="input-error" id="semesterError"></div>
                        </div>
                    </div>

                    <!-- Seguridad -->
                    <div class="form-section">
                        <h3 class="section-title">üîí Crear Contrase√±a</h3>
                        
                        <div class="form-group">
                            <label for="password" class="form-label">Contrase√±a *</label>
                            <div class="password-input-wrapper">
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password" 
                                    class="form-input" 
                                    placeholder="Crea una contrase√±a segura"
                                    maxlength="100"
                                    required
                                >
                                <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                    <span class="password-toggle-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                            <div class="password-strength" id="passwordStrength">
                                <div class="strength-bars">
                                    <div class="strength-bar"></div>
                                    <div class="strength-bar"></div>
                                    <div class="strength-bar"></div>
                                    <div class="strength-bar"></div>
                                </div>
                                <div class="strength-text">Fortaleza de contrase√±a</div>
                            </div>
                            <div class="input-help">
                                Debe contener: 8+ caracteres, may√∫scula, min√∫scula, n√∫mero y s√≠mbolo
                            </div>
                            <div class="input-error" id="passwordError"></div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Confirmar contrase√±a *</label>
                            <div class="password-input-wrapper">
                                <input 
                                    type="password" 
                                    id="confirmPassword" 
                                    name="confirmPassword" 
                                    class="form-input" 
                                    placeholder="Confirma tu contrase√±a"
                                    maxlength="100"
                                    required
                                >
                                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                    <span class="password-toggle-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                            <div class="input-error" id="confirmPasswordError"></div>
                        </div>
                    </div>

                    <!-- T√©rminos y Condiciones -->
                    <div class="form-section">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                                <span class="checkbox-checkmark"></span>
                                <span class="checkbox-text">
                                    He le√≠do y acepto los 
                                    <a href="#" class="link">T√©rminos y Condiciones</a> 
                                    y la <a href="#" class="link">Pol√≠tica de Privacidad</a>
                                </span>
                            </label>
                            <div class="input-error" id="termsError"></div>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="acceptAge" name="acceptAge" required>
                                <span class="checkbox-checkmark"></span>
                                <span class="checkbox-text">
                                    Confirmo que tengo 18 a√±os o m√°s
                                </span>
                            </label>
                            <div class="input-error" id="ageConfirmError"></div>
                        </div>
                    </div>

                    <!-- Bot√≥n de env√≠o -->
                    <div class="form-submit">
                        <button type="submit" class="btn-submit" id="submitBtn">
                            <span class="btn-text">Crear mi cuenta</span>
                            <span class="btn-loading" style="display: none;">
                                <div class="loading-spinner"></div>
                                Creando cuenta...
                            </span>
                        </button>
                    </div>
                </form>

                <!-- Informaci√≥n adicional -->
                <div class="auth-footer">
                    <div class="security-info">
                        <h4>üîê Tu informaci√≥n est√° segura</h4>
                        <p>Utilizamos encriptaci√≥n de grado militar para proteger tus datos personales.</p>
                    </div>
                    
                    <div class="features-preview">
                        <h4>‚ú® Lo que te espera en MySoulMate:</h4>
                        <ul>
                            <li>üéØ Matches basados en compatibilidad real</li>
                            <li>üîí Perfiles an√≥nimos hasta hacer match</li>
                            <li>üí¨ Chat seguro y privado</li>
                            <li>üéì Comunidad universitaria verificada</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de √©xito -->
        <div id="successModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üéâ ¬°Bienvenido/a a MySoulMate!</h3>
                </div>
                <div class="modal-body">
                    <p>Tu cuenta ha sido creada exitosamente.</p>
                    <p>El siguiente paso es completar tu cuestionario de personalidad para encontrar las mejores conexiones.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="goToQuestionnaire()">Completar cuestionario</button>
                </div>
            </div>
        </div>

        <!-- Modal de error -->
        <div id="errorModal" class="modal" style="display: none;">
            <div class="modal-content error">
                <div class="modal-header">
                    <h3>‚ùå Error en el registro</h3>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">Ha ocurrido un error. Int√©ntalo de nuevo.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeErrorModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Inicializar funcionalidades espec√≠ficas del registro
        document.addEventListener('DOMContentLoaded', function() {
            initializeRegisterForm();
            setupPasswordStrengthChecker();
            setupFormValidation();
        });

        // Funciones espec√≠ficas del registro
        function initializeRegisterForm() {
            const form = document.getElementById('registerForm');
            const submitBtn = document.getElementById('submitBtn');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return;
                }

                // Mostrar loading
                showLoading(submitBtn);

                try {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Guardar token
                        localStorage.setItem('authToken', result.token);
                        localStorage.setItem('userData', JSON.stringify(result.user));
                        
                        // Mostrar modal de √©xito
                        showSuccessModal();
                    } else {
                        throw new Error(result.details || result.error || 'Error en el registro');
                    }

                } catch (error) {
                    console.error('Error en registro:', error);
                    showErrorModal(error.message);
                } finally {
                    hideLoading(submitBtn);
                }
            });
        }

        function setupPasswordStrengthChecker() {
            const passwordInput = document.getElementById('password');
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthBars = strengthIndicator.querySelectorAll('.strength-bar');
            const strengthText = strengthIndicator.querySelector('.strength-text');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const strength = calculatePasswordStrength(password);
                
                // Reset bars
                strengthBars.forEach(bar => {
                    bar.className = 'strength-bar';
                });

                // Set strength bars
                for (let i = 0; i < strength.score; i++) {
                    strengthBars[i].classList.add(strength.class);
                }

                strengthText.textContent = strength.text;
            });
        }

        function calculatePasswordStrength(password) {
            let score = 0;
            let feedback = [];

            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[@$!%*?&]/.test(password)) score++;

            const strengthLevels = [
                { score: 0, class: '', text: 'Muy d√©bil' },
                { score: 1, class: 'weak', text: 'D√©bil' },
                { score: 2, class: 'weak', text: 'D√©bil' },
                { score: 3, class: 'medium', text: 'Media' },
                { score: 4, class: 'strong', text: 'Fuerte' },
                { score: 5, class: 'very-strong', text: 'Muy fuerte' }
            ];

            return strengthLevels[score] || strengthLevels[0];
        }

        function validateForm() {
            let isValid = true;
            const form = document.getElementById('registerForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Limpiar errores previos
            clearFormErrors();

            // Validar nombre
            if (!data.name || data.name.trim().length < 2) {
                showFieldError('nameError', 'El nombre debe tener al menos 2 caracteres');
                isValid = false;
            }

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!data.email || !emailRegex.test(data.email)) {
                showFieldError('emailError', 'Ingresa un email v√°lido');
                isValid = false;
            }

            // Validar email universitario
            const universityDomains = ['uvg.edu.gt', 'url.edu.gt', 'unis.edu.gt', 'ufm.edu'];
            const emailDomain = data.email.split('@')[1];
            if (data.email && !universityDomains.some(domain => emailDomain === domain || emailDomain.endsWith('.' + domain))) {
                showFieldError('emailError', 'Debes usar tu email universitario oficial');
                isValid = false;
            }

            // Validar edad
            const age = parseInt(data.age);
            if (!age || age < 18 || age > 35) {
                showFieldError('ageError', 'Debes tener entre 18 y 35 a√±os');
                isValid = false;
            }

            // Validar universidad
            if (!data.university) {
                showFieldError('universityError', 'Selecciona tu universidad');
                isValid = false;
            }

            // Validar contrase√±a
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/;
            if (!data.password || data.password.length < 8 || !passwordRegex.test(data.password)) {
                showFieldError('passwordError', 'La contrase√±a debe tener al menos 8 caracteres, incluyendo may√∫scula, min√∫scula, n√∫mero y s√≠mbolo');
                isValid = false;
            }

            // Validar confirmaci√≥n de contrase√±a
            if (data.password !== data.confirmPassword) {
                showFieldError('confirmPasswordError', 'Las contrase√±as no coinciden');
                isValid = false;
            }

            // Validar t√©rminos
            if (!document.getElementById('acceptTerms').checked) {
                showFieldError('termsError', 'Debes aceptar los t√©rminos y condiciones');
                isValid = false;
            }

            // Validar confirmaci√≥n de edad
            if (!document.getElementById('acceptAge').checked) {
                showFieldError('ageConfirmError', 'Debes confirmar que eres mayor de edad');
                isValid = false;
            }

            return isValid;
        }

        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.input-error');
            errorElements.forEach(element => {
                element.textContent = '';
                element.parentElement.querySelector('.form-input, .form-select')?.classList.remove('error');
            });
        }

        function showFieldError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const inputElement = errorElement.parentElement.querySelector('.form-input, .form-select');
            
            errorElement.textContent = message;
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentElement.querySelector('.password-toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        function showLoading(button) {
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            button.disabled = true;
        }

        function hideLoading(button) {
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            btnText.style.display = 'block';
            btnLoading.style.display = 'none';
            button.disabled = false;
        }

        function showSuccessModal() {
            document.getElementById('successModal').style.display = 'flex';
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function goToQuestionnaire() {
            window.location.href = 'questionnaire.html';
        }
    </script>
</body>
</html>